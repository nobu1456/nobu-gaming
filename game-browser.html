<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Browser</title>

<style>
body {
  margin: 0;
  background: #111;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  color: #fff;
  overflow: hidden;
}

#game {
  position: relative;
  width: min(100vw, 1200px);
  height: min(100vh, 800px);
  background: #000;
  overflow: hidden;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  z-index: 50;
  pointer-events: none;
}

#hearts { font-size: 24px; }
#distance { font-size: 18px; }

#player {
  position: absolute;
  bottom: 40px;
  width: 132px;
  height: 132px;
  background: url("player.png") center / contain no-repeat;
}

.obstacle {
  position: absolute;
  width: 56px;
  height: 56px;
  top: -60px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
}

#gameover {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 200;
}

#rewardNotice {
  color: gold;
  font-weight: bold;
  display: none;
  margin: 6px 0;
}
</style>
</head>

<body>

<div id="game">
  <div id="ui">
    <div id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div id="distance">0m</div>
  </div>
  <div id="player"></div>
</div>

<div id="gameover">
  <h2>GAME OVER</h2>
  <p>Ë∑ùÈõ¢Ôºö<span id="finalDistance"></span>m</p>
  <p id="rewardNotice"></p>
  <button onclick="location.reload()">RETRY</button>
  <button onclick="location.href='reward.html'">ÊôØÂìÅ„ÇíË¶ã„Çã</button>
  <button onclick="location.href='game-start.html'">„Éõ„Éº„É†„Å´Êàª„Çã</button>
</div>

<audio id="bgm" src="bgm.mp3" loop></audio>

<script>
const game = document.getElementById("game");
const player = document.getElementById("player");
const heartsEl = document.getElementById("hearts");
const distanceEl = document.getElementById("distance");
const gameoverEl = document.getElementById("gameover");
const finalDistanceEl = document.getElementById("finalDistance");
const rewardNotice = document.getElementById("rewardNotice");
const bgm = document.getElementById("bgm");

let playerX = 0;
let speed = 4;
let distance = 0;
let lives = 3;
let obstacles = [];
let running = true;
let lastObstacleTime = 0;

let invincible = false;
let invincibleStart = 0;

/* reward.html „Å´Âêà„Çè„Åõ„Åü„Ç≠„Éº */
const rewards = [
  { dist: 500,  key: "reward_500",  shown: false },
  { dist: 1000, key: "reward_1000", shown: false },
  { dist: 1500, key: "reward_1500", shown: false },
  { dist: 2000, key: "reward_2000", shown: false }
];

window.addEventListener("load", () => {
  playerX = game.clientWidth / 2 - player.offsetWidth / 2;
  player.style.left = playerX + "px";
});

const keys = {};
window.addEventListener("keydown", e => {
  keys[e.key] = true;
  if (bgm.paused) bgm.play();
});
window.addEventListener("keyup", e => keys[e.key] = false);

function createObstacle() {
  const obs = document.createElement("div");
  obs.className = "obstacle";
  const enemy = Math.random() < 0.5 ? "enemy1ver2.png" : "enemy2ver2.png";
  obs.style.backgroundImage = `url("${enemy}")`;

  obs.style.left = 40 + Math.random() * (game.clientWidth - 56 - 80) + "px";
  game.appendChild(obs);
  obstacles.push({ el: obs, y: -60 });
}

function updateUI() {
  heartsEl.textContent = "‚ù§Ô∏è".repeat(lives);
  distanceEl.textContent = Math.floor(distance) + "m";
}

function loop(ts) {
  if (!running) return;

  if (keys["ArrowLeft"] || keys["a"]) playerX -= 7;
  if (keys["ArrowRight"] || keys["d"]) playerX += 7;
  playerX = Math.max(0, Math.min(game.clientWidth - player.offsetWidth, playerX));
  player.style.left = playerX + "px";

  distance += 0.1;

  if (Math.floor(distance) % 100 === 0) {
    speed = 4 + Math.floor(distance / 100);
  }

  if (ts - lastObstacleTime > 350 + Math.random() * 250) {
    createObstacle();
    lastObstacleTime = ts;
  }

  const p = player.getBoundingClientRect();

  obstacles.forEach((o, i) => {
    o.y += speed;
    o.el.style.top = o.y + "px";

    const r = o.el.getBoundingClientRect();
    const hit = 10;

    if (!invincible &&
        p.left + hit < r.right - hit &&
        p.right - hit > r.left + hit &&
        p.top + hit < r.bottom - hit &&
        p.bottom - hit > r.top + hit) {

      lives--;
      invincible = true;
      invincibleStart = ts;
      player.style.opacity = "0.5";

      o.el.remove();
      obstacles.splice(i, 1);

      if (lives <= 0) {
        running = false;
        bgm.pause();
        finalDistanceEl.textContent = Math.floor(distance);

        rewards.forEach(rw => {
          if (distance >= rw.dist && !rw.shown) {
            localStorage.setItem(rw.key, "true");
            rewardNotice.textContent = `üéÅ ${rw.dist}m„ÅßÊôØÂìÅËß£ÊîæÔºÅ`;
            rewardNotice.style.display = "block";
            rw.shown = true;
          }
        });

        gameoverEl.style.display = "flex";
      }
    }

    if (o.y > game.clientHeight + 80) {
      o.el.remove();
      obstacles.splice(i, 1);
    }
  });

  if (invincible && ts - invincibleStart > 1000) {
    invincible = false;
    player.style.opacity = "1";
  }

  updateUI();
  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>

</body>
</html>
