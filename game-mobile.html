<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Game Mobile</title>

<style>
/* ===== 基本 ===== */
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  touch-action: none;
}

#game {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  touch-action: none;
}

/* ===== プレイヤー ===== */
#player {
  position: absolute;
  bottom: 48px;
  width: 132px;   /* 1.5倍 */
  height: 132px;
  background: url("player.png") no-repeat center / contain;
  left: 50%;
  transform: translateX(-50%);
  pointer-events: none;
}

/* ===== 敵 ===== */
.obstacle {
  position: absolute;
  width: 56px;
  height: 56px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
  top: -60px;
}

/* ===== スコア ===== */
#score {
  position: fixed;
  top: 10px;
  right: 12px;
  color: #fff;
  font-size: 18px;
  z-index: 10;
}

/* ===== GAME OVER ===== */
#gameover {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: #fff;
  z-index: 20;
}

#gameover button {
  margin: 6px;
  padding: 10px 16px;
  font-size: 16px;
}
</style>
</head>

<body>

<div id="game">
  <div id="player"></div>
</div>

<div id="score">0m</div>

<div id="gameover">
  <h2>GAME OVER</h2>
  <p>距離：<span id="finalScore"></span>m</p>

  <button onclick="location.reload()">RETRY</button>
  <button onclick="location.href='reward.html'">景品を見る</button>
  <button onclick="location.href='game-start.html'">ホームに戻る</button>
</div>

<script>
/* ===== 変数 ===== */
const game = document.getElementById("game");
const player = document.getElementById("player");
const scoreEl = document.getElementById("score");
const gameoverEl = document.getElementById("gameover");
const finalScoreEl = document.getElementById("finalScore");

let playerX = window.innerWidth / 2;
let speed = 4;
let distance = 0;
let lives = 3;
let obstacles = [];
let running = true;
let lastObstacleTime = 0;

const unlocked = new Set();

/* ===== タッチ操作 ===== */
let touchStartX = null;

game.addEventListener("touchstart", e => {
  touchStartX = e.touches[0].clientX;
});

game.addEventListener("touchmove", e => {
  if (touchStartX === null) return;
  const dx = e.touches[0].clientX - touchStartX;
  playerX += dx;
  touchStartX = e.touches[0].clientX;

  const minX = 0;
  const maxX = game.clientWidth - player.offsetWidth;
  playerX = Math.max(minX, Math.min(maxX, playerX));

  player.style.left = playerX + "px";
});

/* ===== 敵生成 ===== */
function createObstacle() {
  const obs = document.createElement("div");
  obs.className = "obstacle";

  const enemy = Math.random() < 0.5 ? "enemy1ver2.png" : "enemy2ver2.png";
  obs.style.backgroundImage = `url("${enemy}")`;

  obs.style.left = Math.random() * (game.clientWidth - 56) + "px";
  obs.style.top = "-60px";

  game.appendChild(obs);
  obstacles.push({ el: obs, y: -60 });
}

/* ===== 報酬チェック ===== */
function checkReward() {
  const best = Math.floor(distance);
  const saved = Number(localStorage.getItem("bestDistance") || 0);

  if (best > saved) {
    localStorage.setItem("bestDistance", best);
  }

  const milestone = Math.floor(best / 500) * 500;
  if (milestone >= 500 && !unlocked.has(milestone)) {
    unlocked.add(milestone);
    console.log("Reward unlocked:", milestone);
  }
}

/* ===== ゲームループ ===== */
function loop(timestamp) {
  if (!running) return;

  distance += 0.1;
  scoreEl.textContent = Math.floor(distance) + "m";

  if (Math.floor(distance) % 100 === 0) {
    speed = 4 + Math.floor(distance / 100);
  }

  const interval = 350 + Math.random() * 250;
  if (timestamp - lastObstacleTime > interval) {
    createObstacle();
    lastObstacleTime = timestamp;
  }

  const p = player.getBoundingClientRect();

  obstacles.forEach((o, i) => {
    o.y += speed;
    o.el.style.top = o.y + "px";

    const r = o.el.getBoundingClientRect();
    const hit = 8;

    if (
      p.left + hit < r.right - hit &&
      p.right - hit > r.left + hit &&
      p.top + hit < r.bottom - hit &&
      p.bottom - hit > r.top + hit
    ) {
      lives--;
      o.el.remove();
      obstacles.splice(i, 1);

      if (lives <= 0) {
        running = false;
        finalScoreEl.textContent = Math.floor(distance);
        checkReward();
        gameoverEl.style.display = "flex";
      }
    }

    if (o.y > game.clientHeight + 80) {
      o.el.remove();
      obstacles.splice(i, 1);
    }
  });

  checkReward();
  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>

</body>
</html>
